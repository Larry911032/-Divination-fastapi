<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”® å€‹äººåŒ–é‹å‹¢ (æ•´åˆç‰ˆ)</title>
    <style>
        body { 
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; 
            background: linear-gradient(135deg, #1a1a2e, #16213e); 
            color: #fff; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px 0;
        }
        .container { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px); 
            padding: 2rem; 
            border-radius: 20px; 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); 
            width: 90%; 
            max-width: 500px; 
            text-align: center; 
            border: 1px solid rgba(255, 255, 255, 0.18); 
        }
        h1 { color: #ffd700; margin-bottom: 1rem; }
        
        /* ç™»å…¥æŒ‰éˆ•æ¨£å¼ */
        .btn-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 1.5rem; }
        .login-btn { display: block; width: 100%; padding: 12px; border-radius: 8px; text-decoration: none; font-weight: bold; color: white; box-sizing: border-box; transition: opacity 0.3s; text-align: center; }
        .login-btn:hover { opacity: 0.8; }
        .btn-google { background-color: #DB4437; border: 1px solid #DB4437; }
        .btn-github { background-color: #24292e; border: 1px solid #ffffff33; }
        .btn-facebook { background-color: #1877F2; border: 1px solid #1877F2; }

        /* ä½¿ç”¨è€…ç‹€æ…‹ */
        .user-status { margin-bottom: 1.5rem; padding: 10px; background: rgba(0, 255, 127, 0.1); border: 1px solid rgba(0, 255, 127, 0.3); border-radius: 8px; color: #8affc1; display: none; }
        .user-status a { color: #ff2e63; margin-left: 10px; text-decoration: none; font-weight: bold; }
        
        /* è¼¸å…¥å€å¡Š */
        .input-group { margin-bottom: 1rem; text-align: left; }
        label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #ccc; }
        input[type="text"], input[type="date"] { width: 100%; padding: 10px; border-radius: 8px; border: none; background: rgba(255, 255, 255, 0.2); color: #fff; box-sizing: border-box; }
        
        /* Checkbox æ¨£å¼ */
        .checkbox-group { text-align: left; margin: 15px 0; display: flex; flex-wrap: wrap; gap: 10px; }
        .checkbox-group label { display: inline-flex; align-items: center; cursor: pointer; color: #fff; margin-bottom: 0; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 20px; transition: 0.2s;}
        .checkbox-group label:hover { background: rgba(255,255,255,0.2); }
        .checkbox-group input { margin-right: 5px; }

        button.submit-btn { width: 100%; padding: 12px; background: #e94560; color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; transition: 0.3s; margin-top: 1rem; }
        button.submit-btn:hover { background: #ff2e63; }
        
        /* çµæœå€å¡Š */
        #result { display: none; margin-top: 2rem; background: rgba(0, 0, 0, 0.2); padding: 1.5rem; border-radius: 10px; text-align: left; animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .result-header { border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; margin-bottom: 10px; }
        .detail-item { margin-bottom:10px; border-bottom:1px dashed #555; padding-bottom:5px; }
        .loading { display: none; text-align: center; margin-top: 20px; color: #ffd700; font-weight: bold; }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ”® ä»Šæ—¥é‹å‹¢å•Ÿç¤º</h1>
    
    <div id="login-buttons" class="btn-container">
        <a href="/login/google" class="login-btn btn-google">G ä½¿ç”¨ Google ç™»å…¥</a>
        <a href="/login/github" class="login-btn btn-github">ğŸ± ä½¿ç”¨ GitHub ç™»å…¥</a>
        <a href="/login/facebook" class="login-btn btn-facebook">f ä½¿ç”¨ Facebook ç™»å…¥</a>
    </div>

    <div id="user-info-area" class="user-status"></div>

    <div class="input-group"><label>ä½ çš„åå­—</label><input type="text" id="name" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜"></div>
    <div class="input-group"><label>ç”Ÿæ—¥</label><input type="date" id="birthday" value="2000-01-01"></div>
    
    <div class="input-group">
        <label>æƒ³è©³ç´°äº†è§£çš„é …ç›®ï¼ˆå¯è¤‡é¸ï¼‰ï¼š</label>
        <div class="checkbox-group">
            <label><input type="checkbox" name="ask" value="æ„Ÿæƒ…"> æ„Ÿæƒ…</label>
            <label><input type="checkbox" name="ask" value="äº‹æ¥­"> äº‹æ¥­</label>
            <label><input type="checkbox" name="ask" value="å­¸æ¥­"> å­¸æ¥­</label>
            <label><input type="checkbox" name="ask" value="è²¡é‹"> è²¡é‹</label>
        </div>
    </div>

    <button class="submit-btn" onclick="getFortune()">é–‹å§‹å åœ</button>
    <div id="loading" class="loading">âœ¨ è§€æ¸¬æ˜Ÿè±¡ä¸­...</div>
    
    <div id="result">
        <div class="result-header">
            <h2 id="res-name" style="margin:0; color:#ffd700;"></h2>
            <small id="res-date" style="color:#aaa;"></small>
            <div style="margin-top:5px;">
                <span id="res-zodiac"></span> | <span id="res-chinese"></span>
            </div>
        </div>
        
        <p id="res-desc" style="line-height: 1.6;"></p>
        
        <div style="display:flex; justify-content: space-between; margin: 15px 0;">
            <div>å¹¸é‹è‰²ï¼š<strong id="res-color" style="color:#e94560;"></strong></div>
            <div>å¹¸é‹æ•¸ï¼š<strong id="res-number" style="color:#e94560;"></strong></div>
        </div>

        <p style="color:#ffd700; font-size:1.5em; font-weight:bold; text-align:center; border: 1px solid rgba(255,215,0,0.3); padding: 10px; border-radius: 10px;">
            ä»Šæ—¥ç¸½é‹ï¼š<span id="res-stars"></span>
        </p>

        <div id="details" style="margin-top: 15px;"></div>
    </div>
</div>

<script>
    // é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
    window.onload = async function() {
        try {
            const response = await fetch('/me');
            const data = await response.json();
            if (data.is_logged_in) {
                document.getElementById('login-buttons').style.display = 'none';
                const infoArea = document.getElementById('user-info-area');
                infoArea.style.display = 'block';
                infoArea.innerHTML = `ğŸ‘‹ å—¨ï¼Œ${data.name}ï¼ <a href="/logout">ç™»å‡º</a>`;
                document.getElementById('name').value = data.name;
            }
        } catch (error) { console.log("å°šæœªç™»å…¥"); }
    };

    async function getFortune() {
        const name = document.getElementById('name').value;
        const birthday = document.getElementById('birthday').value;
        
        // æŠ“å–å‹¾é¸é …ç›®
        const checkboxes = document.querySelectorAll('input[name="ask"]:checked');
        let askList = [];
        checkboxes.forEach((cb) => { askList.push(cb.value); });

        const resultDiv = document.getElementById('result');
        const loading = document.getElementById('loading');
        
        if(!name || !birthday) { alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼"); return; }
        
        loading.style.display = 'block';
        resultDiv.style.display = 'none';

        try {
            const res = await fetch('/fortune', {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, birthday, ask: askList })
            });
            const data = await res.json();
            
            if (res.ok) {
                // å¡«å…¥åŸºæœ¬è³‡æ–™
                document.getElementById('res-name').innerText = `ä½ å¥½ï¼Œ${data.å§“å}`;
                document.getElementById('res-date').innerText = data.ä»Šå¤©æ—¥æœŸ;
                document.getElementById('res-zodiac').innerText = data.æ˜Ÿåº§;
                document.getElementById('res-chinese').innerText = "ç”Ÿè‚–" + data.ç”Ÿè‚–;
                document.getElementById('res-desc').innerText = data.æè¿°;
                document.getElementById('res-stars').innerText = data.é‹å‹¢;
                document.getElementById('res-color').innerText = data.å¹¸é‹é¡è‰²;
                document.getElementById('res-number').innerText = data.å¹¸é‹æ•¸å­—;

                // å‹•æ…‹ç”¢ç”Ÿç´°é …
                let detailHtml = '';
                const cats = ['æ„Ÿæƒ…', 'äº‹æ¥­', 'å­¸æ¥­', 'è²¡é‹'];
                let hasDetails = false;
                
                cats.forEach(cat => {
                    if(data[cat]) { // å¦‚æœå¾Œç«¯æœ‰å›å‚³è©²é …ç›®çš„ç‰©ä»¶
                        hasDetails = true;
                        detailHtml += `
                            <div class="detail-item">
                                <strong style="color:#ffd700;">${cat}é‹å‹¢ï¼š</strong> ${data[cat].stars}<br>
                                <span style="font-size:0.9rem; color:#ddd;">${data[cat].message}</span>
                            </div>`;
                    }
                });
                
                if (!hasDetails && askList.length > 0) {
                     // é˜²å‘†ï¼šæœ‰å‹¾é¸ä½†æ²’å›å‚³è³‡æ–™çš„æƒ…æ³
                } else if (!hasDetails) {
                    detailHtml = '<p style="color:#aaa; font-size:0.8rem; text-align:center;">(åƒ…é¡¯ç¤ºç¸½é‹å‹¢ï¼Œå‹¾é¸ä¸Šæ–¹é …ç›®å¯çœ‹è©³æƒ…)</p>';
                }

                document.getElementById('details').innerHTML = detailHtml;
                resultDiv.style.display = 'block';
            } else {
                alert("éŒ¯èª¤ï¼š" + JSON.stringify(data));
            }
        } catch (error) {
            console.error(error);
            alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
        } finally {
            loading.style.display = 'none';
        }
    }
</script>
</body>
</html>