from fastapi import FastAPI
from pydantic import BaseModel, Field
import random
import datetime

app = FastAPI(
    title="å€‹äººåŒ–æ¯æ—¥é‹å‹¢ API",
    description="æ ¹æ“šå§“åèˆ‡ç”Ÿæ—¥ç”¢ç”Ÿä½ çš„ä»Šæ—¥é‹å‹¢ ğŸ’« å¯è‡ªç”±é¸æ“‡æŸ¥è©¢æ„Ÿæƒ…ã€äº‹æ¥­ã€å­¸æ¥­ã€è²¡é‹",
    version="7.0"
)

class FortuneRequest(BaseModel):
    # Field å‡½å¼åº«å¯ä»¥è®“æ‚¨åŠ å…¥æ›´è©³ç´°çš„èªªæ˜
    name: str = Field(
        ..., 
        description="ä½¿ç”¨è€…çš„å§“å", 
        example="ç‹å°æ˜"
    )
    
    birthday: str = Field(
        ...,
        description="ä½¿ç”¨è€…çš„ç”Ÿæ—¥ï¼Œæ ¼å¼å¿…é ˆç‚º YYYY-MM-DD",
        example="1990-01-31",
        # æ‚¨ä¹Ÿå¯ä»¥åœ¨é€™è£¡åŠ å…¥æ­£è¦è¡¨é”å¼ä¾†é€²è¡Œæ ¼å¼æª¢æŸ¥
        # pattern=r"^\d{4}-\d{2}-\d{2}$" 
    ) 
    
    ask: list[str] = Field(
        ["å…¨éƒ¨"], 
        description="æƒ³è©¢å•çš„é‹å‹¢é …ç›®åˆ—è¡¨ã€‚å¯å¡«å…¥ 'å…¨éƒ¨' æˆ–ç‰¹å®šçš„é …ç›®ï¼Œä¾‹å¦‚ ['æ„›æƒ…', 'äº‹æ¥­']",
        example=["å…¨éƒ¨"]
    )

# --------------------------
# æ˜Ÿåº§åˆ¤æ–·
# --------------------------
def get_zodiac(month: int, day: int) -> str:
    zodiac_dates = [
        ((1, 20), "æ°´ç“¶åº§"), ((2, 19), "é›™é­šåº§"), ((3, 21), "ç‰¡ç¾Šåº§"),
        ((4, 20), "é‡‘ç‰›åº§"), ((5, 21), "é›™å­åº§"), ((6, 22), "å·¨èŸ¹åº§"),
        ((7, 23), "ç…å­åº§"), ((8, 23), "è™•å¥³åº§"), ((9, 23), "å¤©ç§¤åº§"),
        ((10, 24), "å¤©è åº§"), ((11, 23), "å°„æ‰‹åº§"), ((12, 22), "æ‘©ç¾¯åº§")
    ]
    for (m, d), sign in zodiac_dates:
        if (month, day) < (m, d):
            return prev_sign
        prev_sign = sign
    return "æ‘©ç¾¯åº§"

zodiac_traits = {
    "ç‰¡ç¾Šåº§": "ğŸ”¥ å……æ»¿è¡å‹èˆ‡ç†±æƒ… ",
    "é‡‘ç‰›åº§": "ğŸŒ¿ ç©©é‡å¯é ï¼Œé©åˆè¨ˆç•«æœªä¾† ",
    "é›™å­åº§": "ğŸ’« éˆæ´»è°æ˜ï¼Œä½†è¦å°å¿ƒåˆ†å¿ƒ ",
    "å·¨èŸ¹åº§": "ğŸ¦€ æƒ…æ„Ÿè±å¯Œï¼Œé©åˆèˆ‡å®¶äººç›¸è™• ",
    "ç…å­åº§": "ğŸ¦ å…‰èŠ’å››å°„ï¼Œè‡ªä¿¡æ˜¯ä½ çš„æ­¦å™¨ ",
    "è™•å¥³åº§": "âœï¸ è¬¹æ…ç´°å¿ƒï¼Œä»Šå¤©é©åˆæ•´ç†æ€ç·’ ",
    "å¤©ç§¤åº§": "âš–ï¸ äººéš›é‹å¼·ï¼Œä»Šå¤©é©åˆåˆä½œ ",
    "å¤©è åº§": "ğŸ¦‚ ç›´è¦ºæ•éŠ³ï¼Œä»Šå¤©é ç¬¬å…­æ„Ÿ ",
    "å°„æ‰‹åº§": "ğŸ¹ æ¨‚è§€é–‹æœ—ï¼Œå‹‡æ–¼å†’éšª ",
    "æ‘©ç¾¯åº§": "â›°ï¸ å‹™å¯¦è¸å¯¦ï¼Œç©©ä¸­æ±‚å‹ ",
    "æ°´ç“¶åº§": "ğŸª å‰µæ„ç„¡é™ï¼Œè…¦æ´å¤§é–‹ ",
    "é›™é­šåº§": "ğŸŒŠ æ„Ÿæ€§æµªæ¼«ï¼Œå®¹æ˜“é™·å…¥å›æ†¶ "
}

# --------------------------
# ç”Ÿè‚–ã€äº”è¡Œèˆ‡å¹¸é‹é¡è‰²
# --------------------------
zodiacs = ["é¼ ","ç‰›","è™","å…”","é¾","è›‡","é¦¬","ç¾Š","çŒ´","é›","ç‹—","è±¬"]
zodiac_colors = {
    "é¼ ": ["ç™½","ç¶ ","è—"], "ç‰›": ["é»ƒ","æ£•","ç¶ "], "è™": ["æ©˜","é»‘","ç™½"], "å…”": ["ç¶ ","ç²‰","ç™½"],
    "é¾": ["é‡‘","ç´…","é»ƒ"], "è›‡": ["ç´«","ç™½","é»‘"], "é¦¬": ["ç´…","è—","ç´«"], "ç¾Š": ["ç¶ ","é»ƒ","ç²‰"],
    "çŒ´": ["é‡‘","ç™½","ç´…"], "é›": ["ç™½","é‡‘","æ£•"], "ç‹—": ["ç´…","é»ƒ","æ©˜"], "è±¬": ["è—","ç™½","éŠ€"]
}
element_colors = {
    "ç«": ["ç´…","ç¶ ","æ£•","ç´«"], "åœŸ": ["é»ƒ","ç´…","æ£•","ç´«"], "é‡‘": ["ç™½","é»ƒ","æ£•"],
    "æ°´": ["è—","é»‘","ç™½","é‡‘","éŠ€"], "æœ¨": ["ç¶ ","è—","é»‘"]
}
numbers = [3, 6, 7, 8, 9, 11, 12, 18, 22, 27, 33, 42]
extra_tips = [
    "ğŸ€ å¹¸é‹è‰²èƒ½å¸¶çµ¦ä½ å¥½å¿ƒæƒ… ",
    "ğŸ’¤ ä»Šæ™šæ—©é»ä¼‘æ¯ï¼Œæ˜å¤©æœƒæ›´å¥½ ",
    "â˜• ä¸€æ¯ç†±é£²èƒ½å¸¶ä¾†å¹³éœ ",
    "ğŸ“– é©åˆé–±è®€æˆ–å¸æ”¶æ–°çŸ¥ ",
    "ğŸ’¬ å°å¿ƒåˆ¥å’Œè¦ªè¿‘çš„äººèµ·è¡çª ",
    "ğŸ’˜ å¯èƒ½æœƒæ”¶åˆ°æ„æƒ³ä¸åˆ°çš„é—œå¿ƒ ",
    "ğŸ§˜â€â™€ï¸ å˜—è©¦æ”¾ç©ºè‡ªå·±ï¼Œé‡‹æ”¾å£“åŠ› ",
    "ğŸ’ª è‡ªä¿¡æ˜¯ä»Šå¤©æœ€å¼·çš„æ­¦å™¨ "
]
def get_chinese_zodiac(year: int) -> str:
    return zodiacs[(year - 1900) % 12]

def get_element_by_zodiac(zodiac: str) -> str:
    if zodiac in ["çŒ´","é›"]:
        return "é‡‘"
    elif zodiac in ["è™","å…”"]:
        return "æœ¨"
    elif zodiac in ["é¼ ","è±¬"]:
        return "æ°´"
    elif zodiac in ["è›‡","é¦¬"]:
        return "ç«"
    elif zodiac in ["ç‰›","é¾","ç¾Š","ç‹—"]:
        return "åœŸ"
    else:
        return "æœªçŸ¥"

def get_lucky_color(year: int, chinese_zodiac: str) -> str:
    zodiac_col = zodiac_colors[chinese_zodiac]
    element_col = element_colors[get_element_by_zodiac(chinese_zodiac)]
    colors = list(dict.fromkeys(zodiac_col + element_col))  # å»é‡
    return random.choice(colors)


# --------------------------
# ä¸»é‹å‹¢
# --------------------------
luck_levels = {
    1: ("â˜…â˜†â˜†â˜†â˜†", [
        "ğŸ’€ å¤§å‡¶ï¼ä»Šå¤©è«¸äº‹ä¸å®œï¼Œä½èª¿è¡Œäº‹æœ€å®‰å…¨ ",
        "â˜ ï¸ å°å¿ƒè²¡å‹™èˆ‡å¥åº·ï¼Œå»ºè­°å°‘å‡ºé–€ ",
        "âš¡ é¿å…è¡å‹•æ±ºç­–ï¼Œå¯èƒ½æœƒæœ‰æå¤± ",
        "ğŸ˜¢ æƒ…ç·’å®¹æ˜“ä½è½ï¼Œæ³¨æ„ä¼‘æ¯ ",
        "ğŸ›‘ ä¸é©åˆå†’éšªæˆ–æŠ•è³‡ï¼Œä¿æŒå¹³ç©©ç‚ºä¸» "
    ]),
    2: ("â˜…â˜…â˜†â˜†â˜†", [
        "ğŸ˜ å°å‡¶ã€‚æ³¨æ„äººéš›æºé€šèˆ‡é‡‘éŒ¢å•é¡Œ ",
        "âš ï¸ å°å¿ƒæ„å¤–èˆ‡èª¤æœƒï¼Œå‡¡äº‹ä¸‰æ€ ",
        "ğŸŒ€ å·¥ä½œæˆ–å­¸æ¥­å¯èƒ½ä¸é †ï¼Œåˆ¥æ€¥ ",
        "ğŸ˜Ÿ æ„Ÿæƒ…é‹ä½è½ï¼Œéœ€è¦å¤šåŒ…å®¹ ",
        "ğŸ›‹ï¸ é©åˆåœ¨å®¶ä¼‘æ¯ï¼Œé¿å…å¤–å‡ºå†’éšª "
    ]),
    3: ("â˜…â˜…â˜…â˜†â˜†", [
        "ğŸ˜ æ™®é€šã€‚å¹³ç©©çš„ä¸€å¤©ï¼Œä¿æŒå†·éœå°±å¥½ ",
        "ğŸ¤” ä»Šå¤©æ²’å¤ªå¤§æ³¢æŠ˜ï¼ŒæŒ‰éƒ¨å°±ç­å³å¯ ",
        "ğŸ—“ï¸ æ—¥å¸¸é †åˆ©ï¼Œä½†åˆ¥æ‰ä»¥è¼•å¿ƒ ",
        "ğŸ™‚ å¹³æ·¡çš„ä¸€å¤©ï¼Œä¹Ÿæœ‰å°é©šå–œ ",
        "ğŸ’¼ å·¥ä½œæˆ–å­¸æ¥­ç©©å®šï¼Œé©åˆæ•´ç†è¦åŠƒ "
    ]),
    4: ("â˜…â˜…â˜…â˜…â˜†", [
        "ğŸ˜„ å°å‰ã€‚æœ‰è²´äººç›¸åŠ©ï¼Œåšäº‹é †åˆ© ",
        "ğŸŒŸ é‹å‹¢ä½³ï¼Œé©åˆé–‹å•Ÿæ–°è¨ˆç•« ",
        "ğŸ’¡ ä»Šå¤©éˆæ„Ÿè±å¯Œï¼Œäº‹æƒ…å®¹æ˜“æˆåŠŸ ",
        "ğŸ¯ ç›®æ¨™å®¹æ˜“é”æˆï¼ŒæŠ“ä½æ©Ÿæœƒ ",
        "ğŸ˜Š äººéš›é †åˆ©ï¼Œæœ‰åŠ©æ–¼åˆä½œèˆ‡è¡¨ç¾ "
    ]),
    5: ("â˜…â˜…â˜…â˜…â˜…", [
        "ğŸ¤© å¤§å‰ï¼äº‹äº‹é †å¿ƒï¼Œé‹å‹¢çˆ†æ£š ",
        "ğŸ† ä»Šå¤©æœ‰è²´äººé‹ï¼Œå®¹æ˜“é”æˆç›®æ¨™ ",
        "ğŸ‰ å¥½é‹é€£é€£ï¼Œé©åˆæŒ‘æˆ°æ–°äº‹ç‰© ",
        "ğŸ’– æ„Ÿæƒ…é‹å¼·ï¼Œæœƒæœ‰å¥½æ¶ˆæ¯ ",
        "ğŸŒˆ å¹¸é‹æ»¿æ»¿ï¼Œä¿æŒç¬‘å®¹è¿æ¥ä¸€åˆ‡ "
    ])
}

# --------------------------
# å››å¤§é¡é‹å‹¢æ¨¡æ¿
# --------------------------
sub_fortunes = {
    1: ["âš ï¸ ä»Šå¤©ä¸å¤ªé †åˆ© ", "ğŸ’¦ å°å¿ƒä¸€é»æ¯”è¼ƒå®‰å…¨ ", "ğŸ˜£ äº‹æƒ…å¯èƒ½ä¸å¦‚é æœŸ ", "ğŸ›‘ é¿å…é‡å¤§æ±ºç­– "],
    2: ["ğŸ˜• æœ‰äº›å°éº»ç…©ï¼Œä½†å¯ä»¥è™•ç† ", "ğŸ” æ³¨æ„ç´°ç¯€ ", "ğŸ’­ ä¸å¤ªé©åˆæ¨é€²å¤§äº‹ ", "ğŸŒ“ ä¿æŒç©©å®š "],
    3: ["ğŸ™‚ æ™®æ™®é€šé€šçš„ä¸€å¤© ", "ğŸ“˜ ç©©å®šä¸­å‰é€² ", "ğŸª´ ç„¡é¢¨ç„¡é›¨ ", "ğŸ§Š å¹³å¹³é †é † "],
    4: ["âœ¨ æœ‰å°é©šå–œ ", "ğŸŒ± é©åˆå˜—è©¦æ–°äº‹ç‰© ", "ğŸ‘ é‹æ°£ä¸éŒ¯ ", "ğŸ’¡ éˆæ„Ÿä½³ "],
    5: ["ğŸŒˆ è¶…é † ", "ğŸ”¥ äº‹æƒ…é€²å±•å¿«é€Ÿ ", "ğŸ‰ å¯èƒ½æœ‰å¥½æ¶ˆæ¯ ", "ğŸ’ æŠŠæ¡æ©Ÿæœƒ "]
}

love_descriptions = {
    1: ["ğŸ’” æ„Ÿæƒ…æ³¢å‹•å¤§ï¼Œå®¹æ˜“èª¤æœƒ "],
    2: ["ğŸ˜Ÿ æºé€šå¡å¡ï¼Œéœ€è¦è€å¿ƒ "],
    3: ["ğŸ™‚ å¹³ç©©ç„¡æ³¢ç€¾ "],
    4: ["ğŸ’• æ°£æ°›è‰¯å¥½ï¼Œå¯å¢é€²æ„Ÿæƒ… "],
    5: ["ğŸ’– æ¡ƒèŠ±æ—ºç››ï¼Œç¤ºå¥½é©åˆ "]
}

career_descriptions = {
    1: ["âš ï¸ å·¥ä½œå£“åŠ›å¤§ï¼Œå°å¿ƒçŠ¯éŒ¯ "],
    2: ["ğŸ§ é‡åˆ°æŒ‘æˆ°ä½†èƒ½å…‹æœ "],
    3: ["ğŸ“„ å·¥ä½œç©©å®šï¼ŒæŒ‰éƒ¨å°±ç­ "],
    4: ["ğŸ“ˆ è¡¨ç¾äº®çœ¼ï¼Œæœ‰äººæ³¨æ„ä½  "],
    5: ["ğŸ† è¶…ç´šé †åˆ©ï¼Œå»ºè­°ä¸»å‹•å‡ºæ“Š "]
}

study_descriptions = {
    1: ["ğŸ’¤ å°ˆæ³¨åŠ›ä½ï¼Œæ•ˆç‡å·® "],
    2: ["ğŸ“Œ éœ€è¦åŠ å€åŠªåŠ› "],
    3: ["ğŸ“š æ™®æ™®é€šé€šï¼Œç©©å®šå¸æ”¶ "],
    4: ["ğŸ“ ç‹€æ…‹å¥½ï¼Œå®¹æ˜“ç†è§£æ–°å…§å®¹ "],
    5: ["ğŸŒŸ å­¸ç¿’åŠ›çˆ†ç™¼ï¼Œè¶…é©åˆè®€æ›¸ "]
}

wealth_descriptions = {
    1: ["ğŸ’¸ å°å¿ƒç ´è²¡ "],
    2: ["ğŸª™ æœ‰å°æ³¢å‹•ï¼Œä¸å®œæŠ•è³‡ "],
    3: ["ğŸ’µ æ”¶æ”¯å¹³è¡¡ "],
    4: ["ğŸ’³ æœ‰å°ç¢ºå¹¸å¯èƒ½ç™¼ç”Ÿ "],
    5: ["ğŸ¤‘ è²¡é‹æ—ºï¼Œæœ‰é¡å¤–æ”¶å…¥æ©Ÿæœƒ "]
}

fortune_categories = {
    "æ„Ÿæƒ…": love_descriptions,
    "äº‹æ¥­": career_descriptions,
    "å­¸æ¥­": study_descriptions,
    "è²¡é‹": wealth_descriptions
}

def pick_sub_fortune(desc_dict):
    level = random.randint(1, 5)
    return {
        "stars": "â˜…" * level + "â˜†" * (5 - level),
        "message": random.choice(sub_fortunes[level]) + " " + random.choice(desc_dict[level])
    }

# --------------------------
# API
# --------------------------
@app.post("/fortune")
def get_fortune(request: FortuneRequest):
    # ç”Ÿæ—¥è§£æ
    bday = datetime.datetime.strptime(request.birthday, "%Y-%m-%d")
    year, month, day = bday.year, bday.month, bday.day

    # ä¸»é‹å‹¢
    zodiac_sign = get_zodiac(month, day)
    chinese_zodiac = get_chinese_zodiac(year)
    luck_value = random.randint(1, 5)
    luck_star, luck_messages = luck_levels[luck_value]
    luck_message = random.choice(luck_messages)
    zodiac_info = zodiac_traits.get(zodiac_sign, "")
    lucky_color = get_lucky_color(year, chinese_zodiac)
    lucky_number = random.choice(numbers)
    tip = random.choice(extra_tips)

    result = {
        "ä»Šå¤©æ—¥æœŸ": datetime.date.today().isoformat(),
        "å§“å": request.name,
        "å‡ºç”Ÿå¹´æœˆæ—¥": request.birthday,
        "æ˜Ÿåº§": zodiac_sign,
        "ç”Ÿè‚–": chinese_zodiac,
        "é‹å‹¢": luck_star,
        "æè¿°": f"{zodiac_info} {luck_message} {tip}",
        "å¹¸é‹é¡è‰²": lucky_color,
        "å¹¸é‹æ•¸å­—": lucky_number
    }

    # è™•ç†ä½¿ç”¨è€…æŸ¥è©¢é …ç›®
    asks = request.ask
    if "å…¨éƒ¨" in asks:
        asks = ["æ„Ÿæƒ…","äº‹æ¥­","å­¸æ¥­","è²¡é‹"]

    for item in asks:
        if item in fortune_categories:
            result[item] = pick_sub_fortune(fortune_categories[item])
        else:
            result[item] = {"error": f"æ²’æœ‰ã€Œ{item}ã€é€™å€‹é‹å‹¢åˆ†é¡"}

    return result
