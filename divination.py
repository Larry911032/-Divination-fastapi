from fastapi import FastAPI
from pydantic import BaseModel, Field
import random
import datetime
from typing import Optional

# --------------------------
# API åˆå§‹åŒ–
# --------------------------
app = FastAPI(
    title="å€‹äººåŒ–æ¯æ—¥é‹å‹¢ API (ä¿®æ­£ç‰ˆ)",
    description="æ ¹æ“šå§“åèˆ‡ç”Ÿæ—¥ç”¢ç”Ÿä½ çš„ä»Šæ—¥é‹å‹¢ ğŸ’« å¯è‡ªç”±é¸æ“‡æŸ¥è©¢æ„Ÿæƒ…ã€äº‹æ¥­ã€å­¸æ¥­ã€è²¡é‹",
    version="7.1"
)

# --------------------------
# 1. Pydantic è«‹æ±‚æ¨¡å‹
# --------------------------
class FortuneRequest(BaseModel):
    name: str = Field(
        ..., 
        description="ä½¿ç”¨è€…çš„å§“å", 
        example="ç‹å°æ˜"
    )
    
    birthday: str = Field(
        ...,
        description="ä½¿ç”¨è€…çš„ç”Ÿæ—¥ï¼Œæ ¼å¼å¿…é ˆç‚º YYYY-MM-DD",
        example="1990-01-31",
        # å¢åŠ æ­£è¦è¡¨é”å¼ï¼Œè®“ Pydantic è™•ç†æ ¼å¼æª¢æŸ¥ï¼Œé¿å… ValueError
        pattern=r"^\d{4}-\d{2}-\d{2}$" 
    ) 
    
    ask: list[str] = Field(
        ["å…¨éƒ¨"], 
        description="æƒ³è©¢å•çš„é‹å‹¢é …ç›®åˆ—è¡¨ã€‚å¯å¡«å…¥ 'å…¨éƒ¨' æˆ–ç‰¹å®šçš„é …ç›®ï¼Œä¾‹å¦‚ ['æ„›æƒ…', 'äº‹æ¥­']",
        example=["å…¨éƒ¨"]
    )

# --------------------------
# 2. Pydantic å›æ‡‰æ¨¡å‹ (æ–°å¢)
# --------------------------
class SubFortune(BaseModel):
    stars: str = Field(..., description="æ˜Ÿç­‰è¡¨ç¤º (ä¾‹å¦‚: â˜…â˜…â˜…â˜†â˜†)", example="â˜…â˜…â˜…â˜…â˜†")
    message: str = Field(..., description="é‹å‹¢è©³ç´°è¨Šæ¯", example="âœ¨ æœ‰å°é©šå–œ æ°£æ°›è‰¯å¥½ï¼Œå¯å¢é€²æ„Ÿæƒ…")

class FortuneResponse(BaseModel):
    ä»Šå¤©æ—¥æœŸ: str = Field(..., example="2025-11-28")
    å§“å: str = Field(..., example="ç‹å°æ˜")
    å‡ºç”Ÿå¹´æœˆæ—¥: str = Field(..., example="1990-01-31")
    æ˜Ÿåº§: str = Field(..., example="æ°´ç“¶åº§")
    ç”Ÿè‚–: str = Field(..., example="é¦¬")
    é‹å‹¢: str = Field(..., description="ä»Šæ—¥æ•´é«”é‹å‹¢æ˜Ÿç­‰", example="â˜…â˜…â˜…â˜…â˜†")
    æè¿°: str = Field(..., description="ç¶œåˆé‹å‹¢æè¿°èˆ‡å»ºè­°", example="ğŸª å‰µæ„ç„¡é™ï¼Œè…¦æ´å¤§é–‹ ğŸ˜„ å°å‰ã€‚æœ‰è²´äººç›¸åŠ©ï¼Œåšäº‹é †åˆ© ğŸ’¬ å°å¿ƒåˆ¥å’Œè¦ªè¿‘çš„äººèµ·è¡çª")
    å¹¸é‹é¡è‰²: str = Field(..., example="è—")
    å¹¸é‹æ•¸å­—: int = Field(..., example=33)
    
    # é¸å¡«çš„é‹å‹¢é …ç›®
    æ„Ÿæƒ…: Optional[SubFortune] = None
    äº‹æ¥­: Optional[SubFortune] = None
    å­¸æ¥­: Optional[SubFortune] = None
    è²¡é‹: Optional[SubFortune] = None
    # è™•ç†éŒ¯èª¤è¨Šæ¯
    error: Optional[dict] = None

# --------------------------
# 3. æ˜Ÿåº§åˆ¤æ–· (å·²ä¿®æ­£)
# --------------------------
def get_zodiac(month: int, day: int) -> str:
    # (æ—¥æœŸ, æ˜Ÿåº§) åˆ—è¡¨ï¼ŒæŒ‰æœˆä»½é †åºæ’åˆ—
    zodiac_dates = [
        ((1, 20), "æ‘©ç¾¯åº§"),   # 12/22 ~ 1/19
        ((2, 19), "æ°´ç“¶åº§"),   # 1/20 ~ 2/18
        ((3, 21), "é›™é­šåº§"),   # 2/19 ~ 3/20
        ((4, 20), "ç‰¡ç¾Šåº§"),
        ((5, 21), "é‡‘ç‰›åº§"),
        ((6, 22), "é›™å­åº§"),
        ((7, 23), "å·¨èŸ¹åº§"),
        ((8, 23), "ç…å­åº§"),
        ((9, 23), "è™•å¥³åº§"),
        ((10, 24), "å¤©ç§¤åº§"),
        ((11, 23), "å¤©è åº§"),
        ((12, 22), "å°„æ‰‹åº§"),
        # 12/22 ä¹‹å¾Œåˆå›åˆ°æ‘©ç¾¯åº§
    ]
    
    target_date = (month, day)
    
    # æ‘©ç¾¯åº§æ˜¯è·¨å¹´æ˜Ÿåº§ï¼Œéœ€è¦ç‰¹æ®Šè™•ç†
    if target_date >= (12, 22) or target_date < (1, 20):
        return "æ‘©ç¾¯åº§"

    # æ‰¾åˆ°è½åœ¨å“ªå€‹ç¯„åœ
    for (m, d), sign in zodiac_dates:
        # å¦‚æœç›®æ¨™æ—¥æœŸæ—©æ–¼æˆ–ç­‰æ–¼è©²æ˜Ÿåº§çš„èµ·å§‹æ—¥æœŸï¼Œå‰‡å±¬æ–¼å‰ä¸€å€‹æ˜Ÿåº§ (é™¤è·¨å¹´æ˜Ÿåº§å¤–)
        if target_date < (m, d):
            return sign
        
    # åŸºæœ¬ä¸Šä¸æœƒè·‘åˆ°é€™è£¡ï¼Œä½†ä½œç‚ºå›é€€
    return "æœªçŸ¥æ˜Ÿåº§"

# --------------------------
# 4. è³‡æ–™å­—å…¸ (ç¶­æŒä¸è®Š)
# --------------------------
zodiac_traits = {
    "ç‰¡ç¾Šåº§": "ğŸ”¥ å……æ»¿è¡å‹èˆ‡ç†±æƒ… ",
    "é‡‘ç‰›åº§": "ğŸŒ¿ ç©©é‡å¯é ï¼Œé©åˆè¨ˆç•«æœªä¾† ",
    "é›™å­åº§": "ğŸ’« éˆæ´»è°æ˜ï¼Œä½†è¦å°å¿ƒåˆ†å¿ƒ ",
    "å·¨èŸ¹åº§": "ğŸ¦€ æƒ…æ„Ÿè±å¯Œï¼Œé©åˆèˆ‡å®¶äººç›¸è™• ",
    "ç…å­åº§": "ğŸ¦ å…‰èŠ’å››å°„ï¼Œè‡ªä¿¡æ˜¯ä½ çš„æ­¦å™¨ ",
    "è™•å¥³åº§": "âœï¸ è¬¹æ…ç´°å¿ƒï¼Œä»Šå¤©é©åˆæ•´ç†æ€ç·’ ",
    "å¤©ç§¤åº§": "âš–ï¸ äººéš›é‹å¼·ï¼Œä»Šå¤©é©åˆåˆä½œ ",
    "å¤©è åº§": "ğŸ¦‚ ç›´è¦ºæ•éŠ³ï¼Œä»Šå¤©é ç¬¬å…­æ„Ÿ ",
    "å°„æ‰‹åº§": "ğŸ¹ æ¨‚è§€é–‹æœ—ï¼Œå‹‡æ–¼å†’éšª ",
    "æ‘©ç¾¯åº§": "â›°ï¸ å‹™å¯¦è¸å¯¦ï¼Œç©©ä¸­æ±‚å‹ ",
    "æ°´ç“¶åº§": "ğŸª å‰µæ„ç„¡é™ï¼Œè…¦æ´å¤§é–‹ ",
    "é›™é­šåº§": "ğŸŒŠ æ„Ÿæ€§æµªæ¼«ï¼Œå®¹æ˜“é™·å…¥å›æ†¶ "
}

zodiacs = ["é¼ ","ç‰›","è™","å…”","é¾","è›‡","é¦¬","ç¾Š","çŒ´","é›","ç‹—","è±¬"]
zodiac_colors = {
    "é¼ ": ["ç™½","ç¶ ","è—"], "ç‰›": ["é»ƒ","æ£•","ç¶ "], "è™": ["æ©˜","é»‘","ç™½"], "å…”": ["ç¶ ","ç²‰","ç™½"],
    "é¾": ["é‡‘","ç´…","é»ƒ"], "è›‡": ["ç´«","ç™½","é»‘"], "é¦¬": ["ç´…","è—","ç´«"], "ç¾Š": ["ç¶ ","é»ƒ","ç²‰"],
    "çŒ´": ["é‡‘","ç™½","ç´…"], "é›": ["ç™½","é‡‘","æ£•"], "ç‹—": ["ç´…","é»ƒ","æ©˜"], "è±¬": ["è—","ç™½","éŠ€"]
}
element_colors = {
    "ç«": ["ç´…","ç¶ ","æ£•","ç´«"], "åœŸ": ["é»ƒ","ç´…","æ£•","ç´«"], "é‡‘": ["ç™½","é»ƒ","æ£•"],
    "æ°´": ["è—","é»‘","ç™½","é‡‘","éŠ€"], "æœ¨": ["ç¶ ","è—","é»‘"]
}
numbers = [3, 6, 7, 8, 9, 11, 12, 18, 22, 27, 33, 42]
extra_tips = [
    "ğŸ€ å¹¸é‹è‰²èƒ½å¸¶çµ¦ä½ å¥½å¿ƒæƒ… ", "ğŸ’¤ ä»Šæ™šæ—©é»ä¼‘æ¯ï¼Œæ˜å¤©æœƒæ›´å¥½ ",
    "â˜• ä¸€æ¯ç†±é£²èƒ½å¸¶ä¾†å¹³éœ ", "ğŸ“– é©åˆé–±è®€æˆ–å¸æ”¶æ–°çŸ¥ ",
    "ğŸ’¬ å°å¿ƒåˆ¥å’Œè¦ªè¿‘çš„äººèµ·è¡çª ", "ğŸ’˜ å¯èƒ½æœƒæ”¶åˆ°æ„æƒ³ä¸åˆ°çš„é—œå¿ƒ ",
    "ğŸ§˜â€â™€ï¸ å˜—è©¦æ”¾ç©ºè‡ªå·±ï¼Œé‡‹æ”¾å£“åŠ› ", "ğŸ’ª è‡ªä¿¡æ˜¯ä»Šå¤©æœ€å¼·çš„æ­¦å™¨ "
]

luck_levels = {
    1: ("â˜…â˜†â˜†â˜†â˜†", ["ğŸ’€ å¤§å‡¶ï¼ä»Šå¤©è«¸äº‹ä¸å®œï¼Œä½èª¿è¡Œäº‹æœ€å®‰å…¨ ", "â˜ ï¸ å°å¿ƒè²¡å‹™èˆ‡å¥åº·ï¼Œå»ºè­°å°‘å‡ºé–€ "]),
    2: ("â˜…â˜…â˜†â˜†â˜†", ["ğŸ˜ å°å‡¶ã€‚æ³¨æ„äººéš›æºé€šèˆ‡é‡‘éŒ¢å•é¡Œ ", "âš ï¸ å°å¿ƒæ„å¤–èˆ‡èª¤æœƒï¼Œå‡¡äº‹ä¸‰æ€ "]),
    3: ("â˜…â˜…â˜…â˜†â˜†", ["ğŸ˜ æ™®é€šã€‚å¹³ç©©çš„ä¸€å¤©ï¼Œä¿æŒå†·éœå°±å¥½ ", "ğŸ¤” ä»Šå¤©æ²’å¤ªå¤§æ³¢æŠ˜ï¼ŒæŒ‰éƒ¨å°±ç­å³å¯ "]),
    4: ("â˜…â˜…â˜…â˜…â˜†", ["ğŸ˜„ å°å‰ã€‚æœ‰è²´äººç›¸åŠ©ï¼Œåšäº‹é †åˆ© ", "ğŸŒŸ é‹å‹¢ä½³ï¼Œé©åˆé–‹å•Ÿæ–°è¨ˆç•« "]),
    5: ("â˜…â˜…â˜…â˜…â˜…", ["ğŸ¤© å¤§å‰ï¼äº‹äº‹é †å¿ƒï¼Œé‹å‹¢çˆ†æ£š ", "ğŸ† ä»Šå¤©æœ‰è²´äººé‹ï¼Œå®¹æ˜“é”æˆç›®æ¨™ "])
}

sub_fortunes = {
    1: ["âš ï¸ ä»Šå¤©ä¸å¤ªé †åˆ© ", "ğŸ’¦ å°å¿ƒä¸€é»æ¯”è¼ƒå®‰å…¨ ", "ğŸ˜£ äº‹æƒ…å¯èƒ½ä¸å¦‚é æœŸ ", "ğŸ›‘ é¿å…é‡å¤§æ±ºç­– "],
    2: ["ğŸ˜• æœ‰äº›å°éº»ç…©ï¼Œä½†å¯ä»¥è™•ç† ", "ğŸ” æ³¨æ„ç´°ç¯€ ", "ğŸ’­ ä¸å¤ªé©åˆæ¨é€²å¤§äº‹ ", "ğŸŒ“ ä¿æŒç©©å®š "],
    3: ["ğŸ™‚ æ™®æ™®é€šé€šçš„ä¸€å¤© ", "ğŸ“˜ ç©©å®šä¸­å‰é€² ", "ğŸª´ ç„¡é¢¨ç„¡é›¨ ", "ğŸ§Š å¹³å¹³é †é † "],
    4: ["âœ¨ æœ‰å°é©šå–œ ", "ğŸŒ± é©åˆå˜—è©¦æ–°äº‹ç‰© ", "ğŸ‘ é‹æ°£ä¸éŒ¯ ", "ğŸ’¡ éˆæ„Ÿä½³ "],
    5: ["ğŸŒˆ è¶…é † ", "ğŸ”¥ äº‹æƒ…é€²å±•å¿«é€Ÿ ", "ğŸ‰ å¯èƒ½æœ‰å¥½æ¶ˆæ¯ ", "ğŸ’ æŠŠæ¡æ©Ÿæœƒ "]
}
love_descriptions = {1: ["ğŸ’” æ„Ÿæƒ…æ³¢å‹•å¤§ï¼Œå®¹æ˜“èª¤æœƒ "], 2: ["ğŸ˜Ÿ æºé€šå¡å¡ï¼Œéœ€è¦è€å¿ƒ "], 3: ["ğŸ™‚ å¹³ç©©ç„¡æ³¢ç€¾ "], 4: ["ğŸ’• æ°£æ°›è‰¯å¥½ï¼Œå¯å¢é€²æ„Ÿæƒ… "], 5: ["ğŸ’– æ¡ƒèŠ±æ—ºç››ï¼Œç¤ºå¥½é©åˆ "]}
career_descriptions = {1: ["âš ï¸ å·¥ä½œå£“åŠ›å¤§ï¼Œå°å¿ƒçŠ¯éŒ¯ "], 2: ["ğŸ§ é‡åˆ°æŒ‘æˆ°ä½†èƒ½å…‹æœ "], 3: ["ğŸ“„ å·¥ä½œç©©å®šï¼ŒæŒ‰éƒ¨å°±ç­ "], 4: ["ğŸ“ˆ è¡¨ç¾äº®çœ¼ï¼Œæœ‰äººæ³¨æ„ä½  "], 5: ["ğŸ† è¶…ç´šé †åˆ©ï¼Œå»ºè­°ä¸»å‹•å‡ºæ“Š "]}
study_descriptions = {1: ["ğŸ’¤ å°ˆæ³¨åŠ›ä½ï¼Œæ•ˆç‡å·® "], 2: ["ğŸ“Œ éœ€è¦åŠ å€åŠªåŠ› "], 3: ["ğŸ“š æ™®æ™®é€šé€šï¼Œç©©å®šå¸æ”¶ "], 4: ["ğŸ“ ç‹€æ…‹å¥½ï¼Œå®¹æ˜“ç†è§£æ–°å…§å®¹ "], 5: ["ğŸŒŸ å­¸ç¿’åŠ›çˆ†ç™¼ï¼Œè¶…é©åˆè®€æ›¸ "]}
wealth_descriptions = {1: ["ğŸ’¸ å°å¿ƒç ´è²¡ "], 2: ["ğŸª™ æœ‰å°æ³¢å‹•ï¼Œä¸å®œæŠ•è³‡ "], 3: ["ğŸ’µ æ”¶æ”¯å¹³è¡¡ "], 4: ["ğŸ’³ æœ‰å°ç¢ºå¹¸å¯èƒ½ç™¼ç”Ÿ "], 5: ["ğŸ¤‘ è²¡é‹æ—ºï¼Œæœ‰é¡å¤–æ”¶å…¥æ©Ÿæœƒ "]}
fortune_categories = {
    "æ„Ÿæƒ…": love_descriptions, "äº‹æ¥­": career_descriptions, "å­¸æ¥­": study_descriptions, "è²¡é‹": wealth_descriptions
}

# --------------------------
# 5. è¼”åŠ©å‡½æ•¸ (ç¶­æŒä¸è®Š)
# --------------------------
def get_chinese_zodiac(year: int) -> str:
    return zodiacs[(year - 1900) % 12]

def get_element_by_zodiac(zodiac: str) -> str:
    if zodiac in ["çŒ´","é›"]: return "é‡‘"
    elif zodiac in ["è™","å…”"]: return "æœ¨"
    elif zodiac in ["é¼ ","è±¬"]: return "æ°´"
    elif zodiac in ["è›‡","é¦¬"]: return "ç«"
    elif zodiac in ["ç‰›","é¾","ç¾Š","ç‹—"]: return "åœŸ"
    else: return "æœªçŸ¥"

def get_lucky_color(year: int, chinese_zodiac: str) -> str:
    zodiac_col = zodiac_colors[chinese_zodiac]
    element_col = element_colors[get_element_by_zodiac(chinese_zodiac)]
    colors = list(dict.fromkeys(zodiac_col + element_col))
    return random.choice(colors)

def pick_sub_fortune(desc_dict) -> SubFortune:
    level = random.randint(1, 5)
    
    # ç¢ºä¿æ¯å€‹ level éƒ½æœ‰æè¿°ï¼Œå¦‚æœæ²’æœ‰ï¼Œä½¿ç”¨é»˜èªè¨Šæ¯
    desc_list = desc_dict.get(level, ["ç„¡æè¿°"])
    
    return SubFortune(
        stars="â˜…" * level + "â˜†" * (5 - level),
        message=random.choice(sub_fortunes[level]) + " " + random.choice(desc_list)
    )

# --------------------------
# 6. API è·¯ç”± (å·²æ›´æ–° Response Model)
# --------------------------
@app.post("/fortune", response_model=FortuneResponse) # ä½¿ç”¨æ–°çš„ Response Model
def get_fortune(request: FortuneRequest):
    # ç”Ÿæ—¥è§£æ (Pydantic ç¢ºä¿æ ¼å¼æ­£ç¢ºï¼Œæ‰€ä»¥å¯ä»¥å®‰å…¨è§£æ)
    bday = datetime.datetime.strptime(request.birthday, "%Y-%m-%d")
    year, month, day = bday.year, bday.month, bday.day

    # é‹å‹¢è¨ˆç®—
    zodiac_sign = get_zodiac(month, day)
    chinese_zodiac = get_chinese_zodiac(year)
    luck_value = random.randint(1, 5)
    luck_star, luck_messages = luck_levels[luck_value]
    luck_message = random.choice(luck_messages)
    zodiac_info = zodiac_traits.get(zodiac_sign, "")
    lucky_color = get_lucky_color(year, chinese_zodiac)
    lucky_number = random.choice(numbers)
    tip = random.choice(extra_tips)

    # ä¸»é‹å‹¢çµæœ
    result = {
        "ä»Šå¤©æ—¥æœŸ": datetime.date.today().isoformat(),
        "å§“å": request.name,
        "å‡ºç”Ÿå¹´æœˆæ—¥": request.birthday,
        "æ˜Ÿåº§": zodiac_sign,
        "ç”Ÿè‚–": chinese_zodiac,
        "é‹å‹¢": luck_star,
        "æè¿°": f"{zodiac_info.strip()} {luck_message.strip()} {tip.strip()}",
        "å¹¸é‹é¡è‰²": lucky_color,
        "å¹¸é‹æ•¸å­—": lucky_number
    }

    # è™•ç†ä½¿ç”¨è€…æŸ¥è©¢é …ç›®
    asks = request.ask
    if "å…¨éƒ¨" in asks:
        asks = ["æ„Ÿæƒ…","äº‹æ¥­","å­¸æ¥­","è²¡é‹"]

    errors = {}
    for item in asks:
        if item in fortune_categories:
            # å°‡ SubFortune ç‰©ä»¶è³¦å€¼çµ¦å­—å…¸
            result[item] = pick_sub_fortune(fortune_categories[item])
        else:
            errors[item] = f"æ²’æœ‰ã€Œ{item}ã€é€™å€‹é‹å‹¢åˆ†é¡"

    if errors:
        result["error"] = errors

    # è¿”å›çµæœï¼ŒFastAPI æœƒè‡ªå‹•å°‡ Pydantic æ¨¡å‹è½‰æ›ç‚º JSON
    return result