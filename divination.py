from fastapi import FastAPI
from pydantic import BaseModel
import random
import datetime

app = FastAPI(
    title="å€‹äººåŒ–æ¯æ—¥é‹å‹¢ API",
    description="æ ¹æ“šå§“åèˆ‡ç”Ÿæ—¥ç”¢ç”Ÿä½ çš„ä»Šæ—¥é‹å‹¢ ğŸ’«",
    version="5.0"
)

class FortuneRequest(BaseModel):
    name: str
    birthday: str  # YYYY-MM-DD

# æ˜Ÿåº§åˆ¤æ–·
def get_zodiac(month: int, day: int) -> str:
    zodiac_dates = [
        ((1, 20), "æ°´ç“¶åº§"), ((2, 19), "é›™é­šåº§"), ((3, 21), "ç‰¡ç¾Šåº§"),
        ((4, 20), "é‡‘ç‰›åº§"), ((5, 21), "é›™å­åº§"), ((6, 22), "å·¨èŸ¹åº§"),
        ((7, 23), "ç…å­åº§"), ((8, 23), "è™•å¥³åº§"), ((9, 23), "å¤©ç§¤åº§"),
        ((10, 24), "å¤©è åº§"), ((11, 23), "å°„æ‰‹åº§"), ((12, 22), "æ‘©ç¾¯åº§")
    ]
    for (m, d), sign in zodiac_dates:
        if (month, day) < (m, d):
            return prev_sign
        prev_sign = sign
    return "æ‘©ç¾¯åº§"

zodiac_traits = {
    "ç‰¡ç¾Šåº§": "å……æ»¿è¡å‹èˆ‡ç†±æƒ… ğŸ”¥",
    "é‡‘ç‰›åº§": "ç©©é‡å¯é ï¼Œé©åˆè¨ˆç•«æœªä¾† ğŸŒ¿",
    "é›™å­åº§": "éˆæ´»è°æ˜ï¼Œä½†è¦å°å¿ƒåˆ†å¿ƒ ğŸ’«",
    "å·¨èŸ¹åº§": "æƒ…æ„Ÿè±å¯Œï¼Œé©åˆèˆ‡å®¶äººç›¸è™• ğŸ¦€",
    "ç…å­åº§": "å…‰èŠ’å››å°„ï¼Œè‡ªä¿¡æ˜¯ä½ çš„æ­¦å™¨ ğŸ¦",
    "è™•å¥³åº§": "è¬¹æ…ç´°å¿ƒï¼Œä»Šå¤©é©åˆæ•´ç†æ€ç·’ âœï¸",
    "å¤©ç§¤åº§": "äººéš›é‹å¼·ï¼Œä»Šå¤©é©åˆåˆä½œ âš–ï¸",
    "å¤©è åº§": "ç›´è¦ºæ•éŠ³ï¼Œä»Šå¤©é ç¬¬å…­æ„Ÿ ğŸ¦‚",
    "å°„æ‰‹åº§": "æ¨‚è§€é–‹æœ—ï¼Œå‹‡æ–¼å†’éšª ğŸ¹",
    "æ‘©ç¾¯åº§": "å‹™å¯¦è¸å¯¦ï¼Œç©©ä¸­æ±‚å‹ â›°ï¸",
    "æ°´ç“¶åº§": "å‰µæ„ç„¡é™ï¼Œè…¦æ´å¤§é–‹ ğŸª",
    "é›™é­šåº§": "æ„Ÿæ€§æµªæ¼«ï¼Œå®¹æ˜“é™·å…¥å›æ†¶ ğŸŒŠ"
}

# é‹å‹¢ç­‰ç´šï¼Œæ¯å€‹ç­‰ç´šäº”å¥ï¼Œéš¨æ©ŸæŒ‘é¸
luck_levels = {
    1: ("â˜…â˜†â˜†â˜†â˜†", [
        "ğŸ’€ å¤§å‡¶ï¼ä»Šå¤©è«¸äº‹ä¸å®œï¼Œä½èª¿è¡Œäº‹æœ€å®‰å…¨ã€‚",
        "â˜ ï¸ å°å¿ƒè²¡å‹™èˆ‡å¥åº·ï¼Œå»ºè­°å°‘å‡ºé–€ã€‚",
        "âš¡ é¿å…è¡å‹•æ±ºç­–ï¼Œå¯èƒ½æœƒæœ‰æå¤±ã€‚",
        "ğŸ˜¢ æƒ…ç·’å®¹æ˜“ä½è½ï¼Œæ³¨æ„ä¼‘æ¯ã€‚",
        "ğŸ›‘ ä¸é©åˆå†’éšªæˆ–æŠ•è³‡ï¼Œä¿æŒå¹³ç©©ç‚ºä¸»ã€‚"
    ]),
    2: ("â˜…â˜…â˜†â˜†â˜†", [
        "ğŸ˜ å°å‡¶ã€‚æ³¨æ„äººéš›æºé€šèˆ‡é‡‘éŒ¢å•é¡Œã€‚",
        "âš ï¸ å°å¿ƒæ„å¤–èˆ‡èª¤æœƒï¼Œå‡¡äº‹ä¸‰æ€ã€‚",
        "ğŸŒ€ å·¥ä½œæˆ–å­¸æ¥­å¯èƒ½ä¸é †ï¼Œåˆ¥æ€¥ã€‚",
        "ğŸ˜Ÿ æ„Ÿæƒ…é‹ä½è½ï¼Œéœ€è¦å¤šåŒ…å®¹ã€‚",
        "ğŸ›‹ï¸ é©åˆåœ¨å®¶ä¼‘æ¯ï¼Œé¿å…å¤–å‡ºå†’éšªã€‚"
    ]),
    3: ("â˜…â˜…â˜…â˜†â˜†", [
        "ğŸ˜ æ™®é€šã€‚å¹³ç©©çš„ä¸€å¤©ï¼Œä¿æŒå†·éœå°±å¥½ã€‚",
        "ğŸ¤” ä»Šå¤©æ²’å¤ªå¤§æ³¢æŠ˜ï¼ŒæŒ‰éƒ¨å°±ç­å³å¯ã€‚",
        "ğŸ—“ï¸ æ—¥å¸¸é †åˆ©ï¼Œä½†åˆ¥æ‰ä»¥è¼•å¿ƒã€‚",
        "ğŸ™‚ å¹³æ·¡çš„ä¸€å¤©ï¼Œä¹Ÿæœ‰å°é©šå–œã€‚",
        "ğŸ’¼ å·¥ä½œæˆ–å­¸æ¥­ç©©å®šï¼Œé©åˆæ•´ç†è¦åŠƒã€‚"
    ]),
    4: ("â˜…â˜…â˜…â˜…â˜†", [
        "ğŸ˜„ å°å‰ã€‚æœ‰è²´äººç›¸åŠ©ï¼Œåšäº‹é †åˆ©ã€‚",
        "ğŸŒŸ é‹å‹¢ä½³ï¼Œé©åˆé–‹å•Ÿæ–°è¨ˆç•«ã€‚",
        "ğŸ’¡ ä»Šå¤©éˆæ„Ÿè±å¯Œï¼Œäº‹æƒ…å®¹æ˜“æˆåŠŸã€‚",
        "ğŸ¯ ç›®æ¨™å®¹æ˜“é”æˆï¼ŒæŠ“ä½æ©Ÿæœƒã€‚",
        "ğŸ˜Š äººéš›é †åˆ©ï¼Œæœ‰åŠ©æ–¼åˆä½œèˆ‡è¡¨ç¾ã€‚"
    ]),
    5: ("â˜…â˜…â˜…â˜…â˜…", [
        "ğŸ¤© å¤§å‰ï¼äº‹äº‹é †å¿ƒï¼Œé‹å‹¢çˆ†æ£šï¼",
        "ğŸ† ä»Šå¤©æœ‰è²´äººé‹ï¼Œå®¹æ˜“é”æˆç›®æ¨™ã€‚",
        "ğŸ‰ å¥½é‹é€£é€£ï¼Œé©åˆæŒ‘æˆ°æ–°äº‹ç‰©ã€‚",
        "ğŸ’– æ„Ÿæƒ…é‹å¼·ï¼Œæœƒæœ‰å¥½æ¶ˆæ¯ã€‚",
        "ğŸŒˆ å¹¸é‹æ»¿æ»¿ï¼Œä¿æŒç¬‘å®¹è¿æ¥ä¸€åˆ‡ã€‚"
    ])
}

# ç”Ÿè‚–èˆ‡äº”è¡Œå¹¸é‹è‰²
zodiac_colors = {
    "é¼ ": ["ç™½","ç¶ ","è—"], "ç‰›": ["é»ƒ","æ£•","ç¶ "], "è™": ["æ©˜","é»‘","ç™½"], "å…”": ["ç¶ ","ç²‰","ç™½"],
    "é¾": ["é‡‘","ç´…","é»ƒ"], "è›‡": ["ç´«","ç™½","é»‘"], "é¦¬": ["ç´…","è—","ç´«"], "ç¾Š": ["ç¶ ","é»ƒ","ç²‰"],
    "çŒ´": ["é‡‘","ç™½","ç´…"], "é›": ["ç™½","é‡‘","æ£•"], "ç‹—": ["ç´…","é»ƒ","æ©˜"], "è±¬": ["è—","ç™½","éŠ€"]
}
element_colors = {
    "ç«": ["ç´…","ç¶ ","æ£•","ç´«"], "åœŸ": ["é»ƒ","ç´…","æ£•","ç´«"], "é‡‘": ["ç™½","é»ƒ","æ£•"],
    "æ°´": ["è—","é»‘","ç™½","é‡‘","éŠ€"], "æœ¨": ["ç¶ ","è—","é»‘"]
}
numbers = [3, 6, 7, 8, 9, 11, 12, 18, 22, 27, 33, 42]
extra_tips = [
    "ğŸ€ å¹¸é‹è‰²èƒ½å¸¶çµ¦ä½ å¥½å¿ƒæƒ…ï¼",
    "ğŸ’¤ ä»Šæ™šæ—©é»ä¼‘æ¯ï¼Œæ˜å¤©æœƒæ›´å¥½ã€‚",
    "â˜• ä¸€æ¯ç†±é£²èƒ½å¸¶ä¾†å¹³éœã€‚",
    "ğŸ“– é©åˆé–±è®€æˆ–å¸æ”¶æ–°çŸ¥ã€‚",
    "ğŸ’¬ å°å¿ƒåˆ¥å’Œè¦ªè¿‘çš„äººèµ·è¡çªã€‚",
    "ğŸ’˜ å¯èƒ½æœƒæ”¶åˆ°æ„æƒ³ä¸åˆ°çš„é—œå¿ƒã€‚",
    "ğŸ§˜â€â™€ï¸ å˜—è©¦æ”¾ç©ºè‡ªå·±ï¼Œé‡‹æ”¾å£“åŠ›ã€‚",
    "ğŸ’ª è‡ªä¿¡æ˜¯ä»Šå¤©æœ€å¼·çš„æ­¦å™¨ã€‚"
]

# è¨ˆç®—ç”Ÿè‚–
zodiacs = ["é¼ ","ç‰›","è™","å…”","é¾","è›‡","é¦¬","ç¾Š","çŒ´","é›","ç‹—","è±¬"]
def get_chinese_zodiac(year: int) -> str:
    return zodiacs[(year - 1900) % 12]

# è¨ˆç®—äº”è¡Œ
def get_element(year: int) -> str:
    last_digit = year % 10
    if last_digit in [0,1]: return "é‡‘"
    elif last_digit in [2,3]: return "æœ¨"
    elif last_digit in [4,5]: return "æ°´"
    elif last_digit in [6,7]: return "ç«"
    else: return "åœŸ"

# é¸æ“‡å¹¸é‹é¡è‰²
def get_lucky_color(year: int, zodiac_name: str) -> str:
    zodiac_col = zodiac_colors[zodiac_name]
    element_col = element_colors[get_element(year)]
    colors = list(dict.fromkeys(zodiac_col + element_col))  # å»é‡
    return random.choice(colors)

# API
@app.post("/fortune")
def get_fortune(request: FortuneRequest):
    # è§£æç”Ÿæ—¥
    bday = datetime.datetime.strptime(request.birthday, "%Y-%m-%d")
    year, month, day = bday.year, bday.month, bday.day

    # æ˜Ÿåº§
    zodiac_sign = get_zodiac(month, day)

    # ç”Ÿè‚–
    chinese_zodiac = get_chinese_zodiac(year)

    # éš¨æ©Ÿé‹å‹¢
    luck_value = random.randint(1, 5)
    luck_star, luck_messages = luck_levels[luck_value]
    luck_message = random.choice(luck_messages)

    # æ˜Ÿåº§æè¿°
    zodiac_info = zodiac_traits.get(zodiac_sign, "")

    # å¹¸é‹é¡è‰²
    lucky_color = get_lucky_color(year, chinese_zodiac)

    # å¹¸é‹æ•¸å­—
    lucky_number = random.choice(numbers)

    # éš¨æ©Ÿæç¤º
    tip = random.choice(extra_tips)

    # å›å‚³
    return {
        "date": datetime.date.today().isoformat(),
        "name": request.name,
        "birthday": request.birthday,
        "zodiac": zodiac_sign,
        "chinese_zodiac": chinese_zodiac,
        "luck": luck_star,
        "fortune": f"{zodiac_info} {luck_message} {tip}",
        "lucky_color": lucky_color,
        "lucky_number": lucky_number
    }
