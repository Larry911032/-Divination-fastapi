<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nebula æ˜Ÿé›²å åœ | æ¯æ—¥é‹å‹¢</title>
    
    <!-- PWA è¨­å®š -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#16213e">
    <link rel="apple-touch-icon" href="/static/icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- æˆªåœ–å·¥å…· -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* åŸºç¤æ¨£å¼ä¿æŒä¸è®Š */
        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            width: 100%;
            max-width: 450px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        h1 { color: #ffd700; margin-bottom: 1.5rem; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        
        .input-group { margin-bottom: 1rem; text-align: left; }
        label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #ccc; }
        input[type="text"], input[type="date"] {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            box-sizing: border-box;
            font-size: 1rem;
        }

        /* å‹¾é¸æ¡†æ¨£å¼ */
        .checkbox-group {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 8px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .checkbox-item input { margin-right: 5px; transform: scale(1.2); cursor: pointer; }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.3s;
            font-weight: bold;
        }
        .btn-primary { background: #e94560; color: white; margin-top: 10px; }
        .btn-primary:hover { background: #ff2e63; box-shadow: 0 0 15px rgba(233, 69, 96, 0.5); }
        
        .btn-share { 
            background: #0f3460; 
            color: #ffd700; 
            margin-top: 15px; 
            border: 1px solid #ffd700;
        }
        
        #result {
            display: none;
            margin-top: 2rem;
            background: linear-gradient(180deg, rgba(30, 30, 60, 0.95), rgba(20, 20, 40, 0.95));
            padding: 2rem;
            border-radius: 15px;
            text-align: left;
            border: 2px solid #ffd700;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        .fortune-score { font-size: 2rem; color: #ffd700; font-weight: bold; text-align: center; margin: 10px 0; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
        .tag-container { text-align: center; margin-bottom: 15px; }
        .tag {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin: 3px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .detail-item {
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 8px 0;
            font-size: 0.95rem;
            color: #ddd;
        }
        .detail-item:last-child { border-bottom: none; }
        .detail-title { color: #ffd700; font-weight: bold; margin-right: 5px; }
        .footer-note { text-align: center; font-size: 0.7rem; color: #666; margin-top: 20px; display: block; }
        .dev-link { text-align: center; margin-top: 10px; font-size: 0.8rem; }
        .dev-link a { color: #666; text-decoration: none; border-bottom: 1px dashed #666; }
        .loading { display: none; margin-top: 1rem; color: #ffd700; }
    </style>
</head>
<body>

<div class="container">
    <h1>å¤©æ©Ÿ</h1>
    
    <div id="input-area">
        <div class="input-group">
            <label>ä½ çš„åå­—</label>
            <input type="text" id="name" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜" value="ç‹å°æ˜">
        </div>
        
        <div class="input-group">
            <label>ç”Ÿæ—¥ (YYYY-MM-DD)</label>
            <input type="date" id="birthday" value="2000-01-01">
        </div>

        <label style="margin-bottom: 5px;">æƒ³å•ä»€éº¼ï¼Ÿ(è«‹è‡³å°‘é¸ä¸€é …)</label>
        <!-- ğŸ”¥ ä¿®æ”¹é» 1ï¼šæ‹¿æ‰ checked å±¬æ€§ï¼Œé è¨­ä¸å‹¾é¸ -->
        <div class="checkbox-group">
            <label class="checkbox-item"><input type="checkbox" name="ask" value="æ„Ÿæƒ…"> æ„Ÿæƒ…</label>
            <label class="checkbox-item"><input type="checkbox" name="ask" value="äº‹æ¥­"> äº‹æ¥­</label>
            <label class="checkbox-item"><input type="checkbox" name="ask" value="å­¸æ¥­"> å­¸æ¥­</label>
            <label class="checkbox-item"><input type="checkbox" name="ask" value="è²¡é‹"> è²¡é‹</label>
        </div>

        <button class="btn btn-primary" onclick="getFortune()">é–‹å§‹å åœ</button>
    </div>
    
    <p class="loading" id="loading">âœ¨ æ­£åœ¨é€£çµå®‡å®™èƒ½é‡...</p>

    <div id="result">
        <h2 id="res-name" style="margin-top:0; text-align:center; color: #fff;"></h2>
        <p style="text-align:center; color:#aaa; font-size:0.9rem; margin-top:-10px;">ğŸ“… <span id="res-date"></span></p>
        
        <div class="tag-container">
            <span class="tag" id="res-zodiac"></span>
            <span class="tag" id="res-chinese"></span>
            <span class="tag" style="color:#ff9a9e">ğŸ¨ <span id="res-color"></span></span>
            <span class="tag" style="color:#a18cd1">ğŸ”¢ <span id="res-number"></span></span>
        </div>

        <p class="fortune-score" id="res-stars"></p>
        <p id="res-desc" style="line-height: 1.6; text-align: justify;"></p>
        
        <div id="details" style="margin-top: 15px;"></div>
        
        <span class="footer-note">Generated by Nebula æ˜Ÿé›²å åœ App</span>
        <div class="dev-link">
            <a href="/docs" target="_blank">ğŸ”§ é–‹ç™¼è€… API æ–‡ä»¶</a>
        </div>
    </div>

    <button id="share-btn" class="btn btn-share" style="display:none;" onclick="downloadCard()">ğŸ“¸ å„²å­˜é‹å‹¢åœ–å¡</button>
</div>

<script>
    async function getFortune() {
        const name = document.getElementById('name').value;
        const birthday = document.getElementById('birthday').value;
        const resultDiv = document.getElementById('result');
        const shareBtn = document.getElementById('share-btn');
        const loading = document.getElementById('loading');
        
        // å–å¾—å‹¾é¸çš„é …ç›®
        const checkboxes = document.querySelectorAll('input[name="ask"]:checked');
        let askList = Array.from(checkboxes).map(cb => cb.value);
        
        // é©—è­‰è¼¸å…¥
        if(!name || !birthday) {
            alert("è«‹å¡«å¯«å§“åèˆ‡ç”Ÿæ—¥ï¼");
            return;
        }

        // ğŸ”¥ ä¿®æ”¹é» 2ï¼šå¼·åˆ¶ä½¿ç”¨è€…è‡³å°‘é¸ä¸€é …
        if (askList.length === 0) {
            alert("è«‹è‡³å°‘å‹¾é¸ä¸€å€‹ä½ æƒ³çŸ¥é“çš„é‹å‹¢é …ç›®ï¼");
            return; // åœæ­¢åŸ·è¡Œï¼Œä¸ç™¼é€è«‹æ±‚
        }

        loading.style.display = 'block';
        resultDiv.style.display = 'none';
        shareBtn.style.display = 'none';

        try {
            const response = await fetch('/fortune', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    birthday: birthday,
                    ask: askList
                })
            });

            const data = await response.json();

            if (response.ok) {
                document.getElementById('res-name').innerText = data.å§“å;
                document.getElementById('res-date').innerText = data.ä»Šå¤©æ—¥æœŸ;
                document.getElementById('res-zodiac').innerText = data.æ˜Ÿåº§;
                document.getElementById('res-chinese').innerText = "ç”Ÿè‚–" + data.ç”Ÿè‚–;
                document.getElementById('res-color').innerText = data.å¹¸é‹é¡è‰²;
                document.getElementById('res-number').innerText = data.å¹¸é‹æ•¸å­—;
                document.getElementById('res-stars').innerText = data.é‹å‹¢;
                document.getElementById('res-desc').innerText = data.æè¿°;

                let detailHtml = '';
                const cats = ['æ„Ÿæƒ…', 'äº‹æ¥­', 'å­¸æ¥­', 'è²¡é‹'];
                cats.forEach(cat => {
                    if(data[cat]) {
                        detailHtml += `
                        <div class="detail-item">
                            <span class="detail-title">${cat}</span>
                            <span>${data[cat].stars} ${data[cat].message}</span>
                        </div>`;
                    }
                });
                document.getElementById('details').innerHTML = detailHtml;

                resultDiv.style.display = 'block';
                shareBtn.style.display = 'block';
                resultDiv.scrollIntoView({behavior: "smooth"});

            } else {
                alert("éŒ¯èª¤ï¼š" + JSON.stringify(data));
            }
        } catch (error) {
            alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
            console.error(error);
        } finally {
            loading.style.display = 'none';
        }
    }

    function downloadCard() {
        const element = document.getElementById("result");
        const btn = document.getElementById("share-btn");
        btn.innerText = "ğŸ–¼ï¸ ç”Ÿæˆä¸­...";
        btn.disabled = true;

        html2canvas(element, {
            scale: 2,
            backgroundColor: "#1e1e3c",
            useCORS: true
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `fortune_${new Date().toISOString().slice(0,10)}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            btn.innerText = "ğŸ“¸ å„²å­˜é‹å‹¢åœ–å¡";
            btn.disabled = false;
        }).catch(err => {
            console.error(err);
            alert("æˆªåœ–å¤±æ•—ï¼Œè«‹æ‰‹å‹•æˆªåœ–è©¦è©¦ï¼");
            btn.innerText = "ğŸ“¸ å„²å­˜é‹å‹¢åœ–å¡";
            btn.disabled = false;
        });
    }
</script>

</body>
</html>